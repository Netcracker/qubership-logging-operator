# Check if log was parsed by comparing original fields count and final    fields count
[FILTER]
    Name           lua
    Match_regex    (pods|klog).*
    Script         /fluent-bit/etc/count_fields.lua
    Call           second_count_fields

# Try to extract level from log
[FILTER]
    Name           parser
    Match          pods*
    Key_Name       log
    Parser         level_parser_common_keep
    Reserve_Data   On
    Preserve_Key   On

# Copy content of log field to short_message if short_message doesn't exist
[FILTER]
    Name           modify
    Match_regex    (pods|klog).*
    Copy           log          short_message

# Parse dynamic [key=value] labels if log field exists and parsed = true
[FILTER]
    Name           lua
    Match          pods*
    Script         /fluent-bit/etc/parse_key_value.lua
    Call           kv_parse

[FILTER]
    Name                         modify
    Match_Regex                  pods.*grafana.*
    Condition Key_value_matches  log /Invalid\susername\sor\spassword|Successful\sLogin|Successful\sLogout|Failed\sto\slook\sup\suser\sbased\son\scookie/
    Set                          nc_audit_label true

[FILTER]
    Name                         modify
    Match_Regex                  pods.*mongo.*
    Condition Key_value_matches  log /ACCESS|CONTROL/
    Set                          nc_audit_label true

[FILTER]
    Name                         modify
    Match                        pods*
    Condition Key_value_matches  log /access-control|PG_SERVICE|database\ssystem\sis|audit_log_type|AUDIT|logType[\":\s\t=]*audit|org\.qubership\.security\.audit.*CEF|org\.qubership\.cloud\.keycloak\.provider.*/
    Set                          nc_audit_label true

# If log was parsed
# Rename log field to original_log (to be removed in future releases)
# Remove fields used to make a decision on whether message was parsed
[FILTER]
    Name           modify
    Match_regex    (pods|klog).*
    Condition      Key_value_matches  parsed  true
    Hard_rename    log                original_log

# Remove extra fields used for validation
[FILTER]
    Name           record_modifier
    Match_regex    (pods|klog)*
    Remove_key     orig_field_count
    Remove_key     field_count
