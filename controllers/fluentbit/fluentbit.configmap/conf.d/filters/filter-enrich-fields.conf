{{- if .Values.Fluentbit.MockKubeData }}
@INCLUDE /fluent-bit/etc/filter-kubernetes-mock.conf
{{- else }}

# Adds Kubernetes metadata, like pod name, namespace, container name, etc.
# Also reads suggested parser in a pod's annotation. 
# If nothing is proposed, tries to parse log with json parser
# Parsed log is saved under log_parsed field
[FILTER]
    Name                 kubernetes
    Match                pods*
    Kube_URL             https://kubernetes.default.svc:443
    Kube_CA_File         /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File      /var/run/secrets/kubernetes.io/serviceaccount/token
{{- if eq .Values.ContainerRuntimeType "docker" }}
    Kube_Tag_Prefix      pods.var.log.containers.
{{- else }}
    Kube_Tag_Prefix      pods.var.log.pods.
    Regex_Parser         kube-meta
{{- end }}
    Merge_Log            On
    Merge_Log_Key        log_parsed
    K8S-Logging.Parser   On
    K8S-Logging.Exclude  Off
    Buffer_Size          0
{{- end }}

# Next, we will remove all unnecessary fields
[FILTER]
    Name                 nest
    Match                pods*
    Operation            lift
    Wildcard             kubernetes.*
    Nest_under           kubernetes
    Remove_prefix        kubernetes.

# Rename the fields to be more consistent with Monitoring labels
[FILTER]
    Name                 modify
    Match                pods*
    Hard_rename          container_name container
    Hard_rename          namespace_name namespace
    Hard_rename          pod_name pod

# Remove the fields that are not needed
[FILTER]
    Name                 record_modifier
    Match                pods*
    Allowlist_key        namespace
    Allowlist_key        pod
    Allowlist_key        container
    Allowlist_key        source
    Allowlist_key        labels
    Allowlist_key        log
    Allowlist_key        time
    Allowlist_key        level
    Allowlist_key        log_parsed

# Count original fields before extracting parsed fields / passing generic filters
[FILTER]
    Name                 lua
    Match                pods*
    Script               /fluent-bit/etc/count_fields.lua
    Call                 first_count_fields

# Move to upper level parsed fields
[FILTER]
    Name                 nest
    Match                pods*
    Operation            lift
    Wildcard             log_parsed.*
    Nest_under           log_parsed
    Remove_prefix        log_parsed.
